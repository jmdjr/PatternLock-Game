<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <style>
        body {
            margin: 10px;
            padding: 0px;
        }
        .noselect {
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    -khtml-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
}
        .game-frame {
            position: relative;
            background-color: gray;
            padding-bottom: 50px;
            width: 400px;
            float:left;
        }

        .game-board {
            height: 447px;
            width: 479px;
            overflow:hidden;
            position:relative;
        }
        
        .button {
            position: relative;
            float: left;
            border-radius: 25px;
            height: 50px;
            width: 50px;
            border: 3px solid #151515;
            margin-right: 50px;
            background-color: lightgray;
            cursor: pointer;
        }

        .buttons-row {
            position: relative;
            overflow: hidden;
            margin-left: 50px;
            padding-top: 50px;
        }

        .header-frame {
            height: 75px;
            background-color: lightgray;
            border: 2px solid #151515;
        }
        
        .history-frame {
            width: 75px;
            background-color: lightgray;
            border: 2px solid #151515;
            border-top: none;
            float: left;
            height: 366px;
        }

        .lines {
            position: relative;
            z-index: 1;
        }
        
        .path-line {
            position: absolute;
            opacity: .5;
            height: 10px;
            transform-origin:center left;
            background-color: white;
            border: 2px solid #151515;
        }

        
    /*-ms-transform: rotate(7deg); 
    -webkit-transform: rotate(7deg); 
    transform: rotate(7deg);*/
    </style>
</head>
<body>
    <div class="game-board noselect">
        <div class="header-frame">
            <div class="title"></div>
            <div class="score"></div>
        </div>
            <div class="lines"></div>
        <div class="game-frame">
            <div class="buttons-row">
                <div class="button"></div>
                <div class="button"></div>
                <div class="button"></div>
            </div>
            <div class="buttons-row">
                <div class="button"></div>
                <div class="button"></div>
                <div class="button"></div>
            </div>
            <div class="buttons-row">
                <div class="button"></div>
                <div class="button"></div>
                <div class="button"></div>
            </div>
        </div>
        <div class="history-frame"></div>
    </div>

    <script>
        (function ($) {

            var PatternLockGame = function (options, context) {
                this.context = context;
                this.initialize(options);
            }

            var p = PatternLockGame.prototype;

            var defaults = {
                columns: 3,
                rows: 3,
                minimumSolution: 3,
                directions: [
                    { x: 0, y: -1 },    //north
                    { x: 0, y: 1 },     //south
                    { x: 1, y: 0 },     //east
                    { x: -1, y: 0 }     //west
                ],
                compass: {
                    north: 0,
                    south: 1,
                    east: 2,
                    west: 3
                }
            }

            p.solutionList = [];
            p.activelist = [];
            p.nodeElementsList = [];
            p.defaults = {};

            p.initialize = function (options) {
                this.defaults = $.extend({}, defaults, options);
                this.defaults.cells = this.defaults.columns * this.defaults.rows;
                this.defaults.SolutionLength = this.defaults.minimumSolution;

                this.gatherNodeList();
                this.generateSolution();

                this._gameTitle().empty();
                this._gameTitle().append("<div> Number of Nodes in Solution: " + this.defaults.SolutionLength + "</div>");
                this.drawPaths(this.solutionList);
            }

            p._gameBoard = function () { return $(this.context); }
            p._gameHeader = function () { return this._gameBoard().find('.header-frame'); }
            p._gameFrame = function () { return this._gameBoard().find('.game-frame'); }
            p._gameHistory = function () { return this._gameBoard().find('.history-frame'); }
            p._gameTitle = function () { return this._gameHeader().find('.title'); }
            p._gameScore = function () { return this._gameHeader().find('.score'); }
            p._gameLines = function () { return this._gameBoard().find('.lines'); }
            p._gameButtons = function () { return this._gameFrame().find('.button'); }


            p.gatherNodeList = function () {
                this.nodeElementsList = this._nodeElements();
                var game = this;
                $(this.nodeElementsList).each(function (index, item) {
                    var x = index % game.defaults.columns;
                    var y = Math.floor(index / game.defaults.rows);

                    $(item).data('node', {x: x, y: y});
                    $(item).html('<div style="margin: 15px 0px 0px 1px;">x:' + $(item).data('node').x + "||" + 'y:' + $(item).data('node').y + '</div>');// Debug
                });
            }
            
            p._nodeElements = function () {
                return this._gameButtons();
            }

            p.generateSolution = function () {  
                var d = this.defaults;
                var snodes = (Math.floor(Math.random() * (d.cells - d.minimumSolution + 1)) + d.minimumSolution);
                var startX = Math.floor(Math.random() * d.columns);
                var startY = Math.floor(Math.random() * d.rows);
                this.defaults.SolutionLength = snodes;
                this.solutionList = [];
                this.solutionList.push({x:startX, y:startY});

                var i = 1;

                var firstNode = this.solutionList[0];
                var lastNode = this._getRandomNextNode();

                while (i < snodes && firstNode != lastNode) {
                    if (!this._nodeIsInList(lastNode, this.solutionList)) {
                        this.solutionList.push(lastNode);
                        ++i;
                    }

                    lastNode = this._getRandomNextNode();
                }

                if (firstNode == lastNode) {
                    this._gameScore().append("<div>ended on last node: " + this._nodeText(lastNode) + "</div>")
                }
            };

            p._getRandomNextNode = function () {

                var currentNode = this.solutionList[this.solutionList.length - 1];
                var possibleNodes = this._possibleNodes(currentNode);
                var nextNode = null;

                while (nextNode == null) {
                    var pnodeIndex = Math.floor(Math.random() * possibleNodes.length);
                    var pnode = possibleNodes[pnodeIndex];

                    if (this._nodeIsInList(pnode, this.solutionList)) {
                        if (possibleNodes.length == 1) {
                            nextNode = this.solutionList[0];
                        }
                        else {
                            possibleNodes.splice(pnodeIndex, 1);
                        }
                    }
                    else {
                        nextNode = pnode;
                    }
                }

                return nextNode;
            }

            p._sameNode = function (nodeA, nodeB) {
                return nodeA.x == nodeB.x && nodeA.y == nodeB.y;
            }

            p._nodeIsInList = function (node, list) {
                var i, test = false;

                for (i = 0; i < list.length && !test; ++i) {
                    test = test || this._sameNode(node, list[i]);
                }

                return test;
            }

            p._nodeIsInBounds = function (node) {
                return !(node.x >= this.defaults.columns || node.x < 0
                    || node.y >= this.defaults.rows || node.y < 0);
            }

            p._addNodes = function (nodeA, nodeB) {
                return { x: nodeA.x + nodeB.x, y: nodeA.y + nodeB.y };
            }

            p._possibleNodes = function (node) {
                var possibleNodes = [];
                //manually look in all directions.
                var d = this.defaults.directions, c = this.defaults.compass;

                var newNode = this._addNodes(node, d[c.north]);
                if (this._nodeIsInBounds(newNode)) possibleNodes.push(newNode);

                newNode = this._addNodes(node, d[c.south]);
                if (this._nodeIsInBounds(newNode)) possibleNodes.push(newNode);

                newNode = this._addNodes(node, d[c.east]);
                if (this._nodeIsInBounds(newNode)) possibleNodes.push(newNode);

                newNode = this._addNodes(node, d[c.west]);
                if (this._nodeIsInBounds(newNode)) possibleNodes.push(newNode);

                newNode = this._addNodes(this._addNodes(node, d[c.north]), d[c.east]);
                if (this._nodeIsInBounds(newNode)) possibleNodes.push(newNode);

                newNode = this._addNodes(this._addNodes(node, d[c.north]), d[c.west]);
                if (this._nodeIsInBounds(newNode)) possibleNodes.push(newNode);

                newNode = this._addNodes(this._addNodes(node, d[c.south]), d[c.east]);
                if (this._nodeIsInBounds(newNode)) possibleNodes.push(newNode);

                newNode = this._addNodes(this._addNodes(node, d[c.south]), d[c.west]);
                if (this._nodeIsInBounds(newNode)) possibleNodes.push(newNode);

                return possibleNodes.slice(0);
            }


            p.drawPaths = function (list) {
                var text = "";
                var i=0;
                while (i < list.length - 1) {
                    this._lineFromNodeToNode(list[i], list[i + 1]);
                    text = text + this._nodeText(list[i]) + ">>"; // Debug
                    ++i;
                }
                text = text + this._nodeText(list[i]);// Debug
                this._gameTitle().append("<div>" + text + "</div>");// Debug
            }

            p._nodeText = function (node) { return "(" + node.x + ", " + node.y + ")" }

            p._lineFromNodeToNode = function (nodeA, nodeB) {
                var itemA = this._getNodeElement(nodeA);
                var itemB = this._getNodeElement(nodeB);
                var positionA = itemA.offset();
                var positionB = itemB.offset();

                var line = $('<div class="path-line"></div>');

                var AxEqBx = nodeA.x == nodeB.x;
                var AyEqBy = nodeA.y == nodeB.y;
                var AxGtBx = nodeA.x > nodeB.x;
                var AyGtBy = nodeA.y > nodeB.y;
                var AxLtBx = nodeA.x < nodeB.x;
                var AyLtBy = nodeA.y < nodeB.y;


                var rotate = 0;
                if(AxEqBx && AyGtBy) { rotate = -90; }
                else if (AxEqBx && AyLtBy) { rotate = 90; }
                else if (AxGtBx && AyEqBy) { rotate = 180; }
                else if (AxLtBx && AyEqBy) { rotate = 0; }
                else if (AxGtBx && AyGtBy) { rotate = -135; }
                else if (AxGtBx && AyLtBy) { rotate = 135; }
                else if (AxLtBx && AyGtBy) { rotate = -45; }
                else if (AxLtBx && AyLtBy) { rotate = 45; }

                var width = Math.sqrt(Math.pow(positionB.left - positionA.left, 2) + Math.pow(positionB.top - positionA.top, 2));

                positionA.top;

                var top = positionA.top;
                var left = positionA.left;
                this._gameLines().append(line);
                line.css({
                    top: top,
                    left: left,
                    width: width,
                    transform: "rotate(" + rotate + "deg)"
                });
            }

            p._getNodeElement = function (nodeA) {
                var i = 0, element = null, item = null;
                var list = this.nodeElementsList;
                var item;
                while (i < list.length && element == null) {
                    item = list[i];

                    if (this._sameNode(nodeA, $(item).data('node'))) {
                        return $(item);
                    }
                    ++i;
                }
            }

            $.fn.PatternLockGame = function (options) {
                $(this).each(function () { $(this).data('calendar', new PatternLockGame(options, this)); });
            }
        })(jQuery);

    </script>

    <script>
        $('.game-board').PatternLockGame();
    </script>
</body>
</html>
