<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <style>
        body {
            margin: 10px;
            padding: 0px;
        }

        .game-frame {
            position: relative;
            background-color: gray;
            padding-bottom: 50px;
            width: 400px;
            float:left;
        }

        .game-board {
            height: 447px;
            width: 479px;
            overflow:hidden;
            position:relative;
        }
        
        .button {
            position: relative;
            float: left;
            border-radius: 25px;
            height: 50px;
            width: 50px;
            border: 3px solid #151515;
            margin-right: 50px;
            background-color: lightgray;
            cursor: pointer;
        }

        .buttons-row {
            position: relative;
            overflow: hidden;
            margin-left: 50px;
            padding-top: 50px;
        }

        .header-frame {
            height: 75px;
            background-color: lightgray;
            border: 2px solid #151515;
        }
        
        .history-frame {
            width: 75px;
            background-color: lightgray;
            border: 2px solid #151515;
            border-top: none;
            float: left;
            height: 366px;
        }
    </style>
</head>
<body>
    <div class="game-board">
        <div class="header-frame">
            <div class="title"></div>
            <div class="score"></div>
        </div>
        <div class="game-frame">
            <div class="lines"></div>
            <div class="buttons-row">
                <div class="button"></div>
                <div class="button"></div>
                <div class="button"></div>
            </div>
            <div class="buttons-row">
                <div class="button"></div>
                <div class="button"></div>
                <div class="button"></div>
            </div>
            <div class="buttons-row">
                <div class="button"></div>
                <div class="button"></div>
                <div class="button"></div>
            </div>
        </div>
        <div class="history-frame"></div>
    </div>

    <script>
        (function ($) {

            var PatternLockGame = function (options, context) {
                this.context = context;
                this.initialize(options);
            }

            var p = PatternLockGame.prototype;

            var defaults = {
                columns: 3,
                rows: 3,
                minimumSolution: 3,
                directions: [
                    { x: 0, y: -1 },    //north
                    { x: 0, y: 1 },     //south
                    { x: 1, y: 0 },     //east
                    { x: -1, y: 0 }     //west
                ],
                compass: {
                    north: 0,
                    south: 1,
                    east: 2,
                    west: 3
                }

            }


            p.initialize = function (options) {
                this.defaults = $.extend({}, defaults, options);


                this.defaults.cells = this.defaults.columns * this.defaults.rows;
                this.solutionList = [];
                this.activelist = [];
                this.nodeList = [];

                this.gatherNodeList();
                this.generateSolution();
            }

            p.nodes = function () {
                return $(this.context).find('.button');
            }

            p.gatherNodeList = function () {
                this.nodeList = this.nodes();
                var game = this;
                $(this.nodeList).each(function (index, item) {
                    $(item).data('x', index % game.defaults.columns);
                    $(item).data('y', Math.floor(index / game.defaults.rows));

                    //$(item).html('<div style="margin: 15px 0px 0px 1px;">x:' + $(item).data('x') + "||" + 'y:' + $(item).data('y') + '</div>');
                });
            }

            p.generateSolution = function () {

                var snodes = Math.floor(Math.random() * this.defaults.cells) + this.defaults.minimumSolution % this.defaults.cells;
                var startX = Math.floor(Math.random() * this.defaults.columns);
                var startY = Math.floor(Math.random() * this.defaults.rows);

                this.solutionList = [];
                this.solutionList.push({x:startX, y:startY});

                var i = 1;

                var firstNode = this.solutionList[0];
                var lastNode = this._getRandomNextNode();

                while (i < snodes || firstNode == lastNode) {
                    this.solutionList.push(lastNode);
                    lastNode = this._getRandomNextNode();
                    ++i;
                }

                debugger;
            };

            p._sameNode = function (nodeA, nodeB) {
                return nodeA.x == nodeB.x && nodeA.y == nodeB.y;
            }
            
            p._nodeIsInBounds = function (node) {
                return !(node.x >= this.defaults.columns || node.x < 0
                    || node.y >= this.defaults.rows || node.y < 0);
            }

            p._addNodes = function (nodeA, nodeB) {
                return { x: nodeA.x + nodeB.x, y: nodeA.y + nodeB.y };
            }

            p._possibleNodes = function (node) {
                var possibleNodes = [];
                //manually look in all directions.
                var d = this.defaults.directions, c = this.defaults.compass;

                var newNode = this._addNodes(node, d[c.north]);
                if (this._nodeIsInBounds(newNode)) possibleNodes.push(newNode);

                newNode = this._addNodes(node, d[c.south]);
                if (this._nodeIsInBounds(newNode)) possibleNodes.push(newNode);

                newNode = this._addNodes(node, d[c.east]);
                if (this._nodeIsInBounds(newNode)) possibleNodes.push(newNode);

                newNode = this._addNodes(node, d[c.west]);
                if (this._nodeIsInBounds(newNode)) possibleNodes.push(newNode);

                newNode = this._addNodes(this._addNodes(node, d[c.north]), d[c.east]);
                if (this._nodeIsInBounds(newNode)) possibleNodes.push(newNode);

                newNode = this._addNodes(this._addNodes(node, d[c.north]), d[c.west]);
                if (this._nodeIsInBounds(newNode)) possibleNodes.push(newNode);

                newNode = this._addNodes(this._addNodes(node, d[c.south]), d[c.east]);
                if (this._nodeIsInBounds(newNode)) possibleNodes.push(newNode);

                newNode = this._addNodes(this._addNodes(node, d[c.south]), d[c.west]);
                if (this._nodeIsInBounds(newNode)) possibleNodes.push(newNode);

                return possibleNodes.slice(0);
            }

            p._getRandomNextNode = function () {

                var currentNode = this.solutionList[this.solutionList.length - 1];
                var possibleNodes = this._possibleNodes(currentNode);
                var nextNode = null;
                var game = this;

                var pnodeIndex = Math.floor(Math.random() * possibleNodes.length);
                var pnode = possibleNodes[pnodeIndex];

                while(nextNode == null) {
                    for (var solutionIndex = 0; solutionIndex < this.solutionList.length; ++solutionIndex) {
                        var snode = this.solutionList[solutionIndex];
                        if (this._sameNode(snode, pnode)) {

                            if (possibleNodes.length == 1) {
                                nextNode = this.solutionList[0];
                                debugger;
                            }
                            else {
                                possibleNodes.splice(pnodeIndex, 1);
                            }
                        }
                        else {
                            nextNode = pnode;
                        }
                    }
                }

                return nextNode;
            }

            $.fn.PatternLockGame = function (options) {
                $(this).each(function () { $(this).data('calendar', new PatternLockGame(options, this)); });
            }
        })(jQuery);

    </script>

    <script>
        $('.game-board').PatternLockGame();

    </script>
</body>
</html>
