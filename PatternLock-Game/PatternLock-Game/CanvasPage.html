<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Pattern Lock Game V 2.0</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <script src="http://sugarjs.com/release/current/sugar.min.js"></script>
    <script src="Script/phaser.js"></script>
    <script src="Script/jquerymy-1.1.4.js"></script>
</head>
<body>
    <script>
        var game = new Phaser.Game(308, 492, Phaser.AUTO, '', { preload: preload, create: create, update: update });

        WebFontConfig = {

            //  'active' means all requested fonts have finished loading
            //  We set a 1 second delay before calling 'createText'.
            //  For some reason if we don't the browser cannot render the text the first time it's created.
            //active: function () { game.time.events.add(Phaser.Timer.SECOND, createText, this); },

            //  The Google Fonts we want to load (specify as many as you like in the array)
            google: {
                families: ['Audiowide']
            }

        };

        function preload() {
            DeviceScreenManager.preload(game);
            GameButtonFactory.preload(game);
            TouchScreenDisplays.preload(game);
        }

        function create() {
            DeviceScreenManager.create(game);

        }

        function update() {
            DeviceScreenManager.update(game);
        }

        //*******************************************************************************************************************************************************
        //                   Game Resources - Buttons: Manager for all button related activities.
        //*******************************************************************************************************************************************************
        var GameButtonFactory = {
            info: {
                key: 'buttons',
                src: 'Resources/ButtonsSpriteSheet.png',
                height: 34,
                width: 34
            },

            buttonState: { 
                Idle: 0,
                Active: 1
            },

            overlayState: {
                Correct: 2,
                Wrong: 3,
                Over: 4,
                Close: 5,
                Under: 6
            },

            preload: function (game) {
                game.load.spritesheet(this.info.key, this.info.src, this.info.height, this.info.width, 7);
            },

            button: function (game, x, y, xpad, ypad) {
                Phaser.Sprite.call(this, game, x * (GameButtonFactory.info.width + xpad), y * (GameButtonFactory.info.height + ypad), GameButtonFactory.info.key, GameButtonFactory.buttonState.Idle);
                this._active = false;
                this._pos = { x: x, y: y };
            }
        }

        var p = GameButtonFactory.button.prototype = Object.create(Phaser.Sprite.prototype);
        GameButtonFactory.button.prototype.constructor = GameButtonFactory.button;
        
        p.activate = function () {
            this.frame = GameButtonFactory.buttonState.Active;
            this._active = true;
        }

        p.deactivate = function () {
            this.frame = GameButtonFactory.buttonState.Idle;
            this._active = false;
        }

        p.update = function () {

        }

        //*******************************************************************************************************************************************************
        //                   Game Resources - DeviceScreenManager
        //*******************************************************************************************************************************************************
        // The Device Screen Manager deals with rendering the main game display, such as the border box, and acts as the device, loading Touch Screen Displays
        // into the device layers.
        var DeviceScreenManager = {
            info: {
                screenFrame: {
                    ref: null,
                    key: 'frame',
                    src: 'Resources/cellphone.png',
                },
                
                height: 492,
                width: 308,
                top: 69,
                left: 27,
                bottom: 393,
                right: 283
            },

            _background: null,
            _midground: null,
            _forground: null,

            preload: function (game) {
                game.load.image(this.info.screenFrame.key, this.info.screenFrame.src);
            },

            create: function (game) {
                this._background = game.add.group();
                this._midground = game.add.group();
                this._forground = game.add.group();

                this._drawBaseGraphics(game);

                TouchScreenDisplays.create(game);
                this._midground.add(TouchScreenDisplays.getFrame());
            }, 

            _drawBaseGraphics: function (game) {
                this.info.screenFrame.ref = game.add.sprite(0, 0, this.info.screenFrame.key, this.info.screenFrame.src);
                this._forground.add(this.info.screenFrame.ref);
            },

            update: function (game) {
                TouchScreenDisplays.update(game);
            }
        }
        //*******************************************************************************************************************************************************
        //                   Game Manager - Touch Screens
        //*******************************************************************************************************************************************************

        //var tempalteDisplay = {
        //    preload: function (game) { },
        //    create: function (game) { },
        //    getDisplay: function (game) { }
        //}

        //     Game Resource - Screen displays
        //-------------------------------------------------------------------------------------------------------------------------------------------------------

        var titleScreenDisplay = {
            _created: false,
            Logo: {
                key: 'logoImage',
                src: 'Resources/FlipStickLogo.png',
                frames: 29,
                height: 600,
                width: 120,
                rate: 24,
                ref: null,
                top: 0,
                left: 85,
                scale: new Phaser.Point(0.75, 0.50)
            },

            displayTimerRef: null,
            _displayGroup: null,

            preload: function (game) {
                game.load.script('webfont', '//ajax.googleapis.com/ajax/libs/webfont/1.4.7/webfont.js');
                game.load.spritesheet(this.Logo.key, this.Logo.src, this.Logo.width, this.Logo.height);
            },

            create: function (game) {
                game.stage.setBackgroundColor(0x33CC33);
                this.Logo.ref = game.make.sprite(this.Logo.left, this.Logo.top, this.Logo.key);
                this.Logo.ref.scale = this.Logo.scale;
                this.Logo.ref.animations.add('flip', null, this.Logo.rate, false);
                this.Logo.ref.animations.play('flip');

                this._displayGroup = game.make.group();
                this._displayGroup.add(this.Logo.ref);

                this.displayTimerRef = game.time.create();
                this.displayTimerRef.add(1000, this._createLogoTitle, this, game);
                this.displayTimerRef.add(3000, this._transition, this);
                this.displayTimerRef.start();
                this._created = true;
            },

            _createLogoTitle: function (game) {
                var text = game.make.text(128, 50, "\\ Flip Stick Games /");

                text.anchor.set(0.5);
                text.align = 'center';
                text.font = 'Audiowide';
                text.fontWeight = 'bold';
                text.fontSize = 20;
                text.fill = '#000000';
                this._displayGroup.add(text);
            },

            _transition: function () {
                TouchScreenDisplays.nextDisplay();
            },

            getDisplay: function (game) {
                return this._displayGroup;
            },

            update: function (game) {

            }
        }

        //-------------------------------------------------------------------------------------------------------------------------------------------------------
        // 
        var gameLogic = {
            defaults: {
                rows: 3,
                columns: 3,
                minimumSolution: 4,
                maximumSolution: 9,
                maxTries: 20,
                SolutionLength: 4,
                showPatternRelativePosition: true,
                directions: [
                    { x: 0, y: -1 },    //north
                    { x: 0, y: 1 },     //south
                    { x: 1, y: 0 },     //east
                    { x: -1, y: 0 }     //west
                ],
                compass: {
                    north: 0,
                    south: 1,
                    east: 2,
                    west: 3
                },
                states: {
                    correct: 'correct',
                    before: 'before',
                    after: 'after',
                    close: 'close',
                    wrong: 'wrong'
                }
            },

            GameNode: function (x, y, state) {
                this.x = x || 0;
                this.y = y || 0;
                this.state = state || defaults.states.wrong;

                this.toString = function () { return '(' + this.x + ", " + '' + this.y + ')'; }
            },

            activeList: [],
            solutionList: [],
            userList: [],
            historyList: [],
            nodeElementsList: [],

            _gatherNodeList: function () {
                var index = 0;
                while (index < this.nodeElementsList.length) {
                    var item = this.nodeElementsList[index];
                    var x = index % this.defaults.columns;
                    var y = Math.floor(index / this.defaults.rows);
                    var node = new GameNode(x, y);
                    $(item).data('node', node);

                    ++index;
                }
            },
        }

        //-------------------------------------------------------------------------------------------------------------------------------------------------------
        var gameScreenDisplay = {
            _created: false,
            screenBackground: {
                ref: null,
                key: 'screenBackground',
                src: 'Resources/background_1.png'
            },

            textGraphic: {
                key: 'swipeText',
                src: 'Resources/phoneText.png',
                scale: new Phaser.Point(0.75, 0.75),
                ref: null
            },

            
            lockPatterns: {
                small3x3: {
                    v: 3,
                    h: 3,
                    vpad: 20,
                    hpad: 20,
                    top: 130,
                    left: 66,
                    textX: 65,
                    textY: 100
                },
                medium4x4: {
                    v: 4,
                    h: 4,
                    vpad: 10,
                    hpad: 10,
                    top: 131,
                    left: 43,
                    textX: 65,
                    textY: 100
                },
                odd5x3: {
                    v: 5,
                    h: 3,
                    vpad: 10,
                    hpad: 10,
                    top: 96,
                    left: 68,
                    textX: 65,
                    textY: 100
                }
            },
            
            _lockButtons: null,
            _display: null,

            preload: function (game) {
                game.load.image(this.screenBackground.key, this.screenBackground.src);
                game.load.image(this.textGraphic.key, this.textGraphic.src);
            },

            _initGame: function () {
                gameLogic.defaults.cells = this._lockPattern.v * this._lockPattern.h;
                gameLogic.defaults.rows = this._lockPattern.v;
                gameLogic.defaults.columns = this._lockPattern.h;
                gameLogic.nodeElementsList = this._lockButtons;
            },


            _nodeElements: function () {
                return this._lockButtons;
            },

            create: function (game) {
                this._lockPattern = this.lockPatterns.small3x3;
                this._lockButtons = game.make.group();
                this._createLockButtons(game);


                this.screenBackground.ref = game.make.sprite(0, 0, this.screenBackground.key);
                //this.textGraphic.ref = game.make.sprite(this._lockPattern.textX, this._lockPattern.textY, this.textGraphic.key);
                //this.textGraphic.ref.scale = this.textGraphic.scale;

                this._lockButtons.x = this._lockPattern.left;
                this._lockButtons.y = this._lockPattern.top;

                this._display = game.make.group();

                this._display.add(this.screenBackground.ref);
                //this._display.add(this.textGraphic.ref);
                this._display.add(this._lockButtons);

                //this._initGame();

                this._created = true;
            },
            
            // returns the assets which belong in the foreground
            getDisplay: function(game) {
                return this._display;
            },

            update: function (game) {
            },

            _createLockButtons: function (game) {
                if (this._lockPattern == null) {
                    return null;
                }

                var vp = this._lockPattern.vpad || 0;
                var hp = this._lockPattern.hpad || 0;

                for (var i = 0; i < this._lockPattern.v; ++i) {
                    for (var j = 0; j < this._lockPattern.h; ++j) {
                        var button = new GameButtonFactory.button(game, j, i, vp, hp);

                        //if (((i * w) + j) % 2 == 0) {
                        //    button.changeState(GameButtonFactory.buttonState.Active);
                        //}

                        this._lockButtons.add(button);
                    }
                }

                //this._lockButtons.setAll('inputEnabled', true);
                //this._lockButtons.callAll('events.onInputDown.add', 'events.onInputDown', gameScreenDisplay._buttonClicked);
            },

            _buttonClicked: function (item) {
                if (item._active) {
                    item.deactivate();
                }
                else {
                    item.activate();
                }
            }
        }


        //-------------------------------------------------------------------------------------------------------------------------------------------------------
        //-------------------------------------------------------------------------------------------------------------------------------------------------------

        var TouchScreenDisplays = {
            info: {
                top: 69,
                left: 27,
            },

            // more scenes here for title screen, pause etc...
            screenDisplays: [titleScreenDisplay, gameScreenDisplay],
            
            _displayIndex: 0,

            _dirtyDisplay: true,

            _CurrentDisplay: null,

            _frame: null,

            preload: function (game) {
                var i = 0;
                while (i < this.screenDisplays.length) {
                    this.screenDisplays[i].preload(game);
                    ++i;
                }
            },

            create: function (game) {
                this._CurrentDisplay = this.screenDisplays[this._displayIndex];

                this._frame = game.add.group();
                this._frame.x = this.info.left;
                this._frame.y = this.info.top;

                this.setupGraphics(game);
            },

            setupGraphics: function (game) {
                this._frame.removeAll();
                this._CurrentDisplay.create(game);
                this._frame.add(this._CurrentDisplay.getDisplay(game));
                this._dirtyDisplay = false;
            },

            getFrame: function() {
                return this._frame;
            },

            shouldRefresh: function () {
                return this._dirtyDisplay;
            },

            setDisplay: function (index) {
                if (0 < index && index < this.screenDisplays.length) {
                    this._CurrentDisplay = this.screenDisplays[index];
                    this._displayIndex = index;
                    this._dirtyDisplay = true;
                }
            },
            
            nextDisplay: function () {
                this.setDisplay(this._displayIndex + 1);
            },

            update: function (game) {
                if (this.shouldRefresh()) {
                    this.setupGraphics(game);
                }

                if (this._CurrentDisplay.update) {
                    this._CurrentDisplay.update();
                }
            }
        }

        //*******************************************************************************************************************************************************
        //                   Game Resources - Debug Control
        //*******************************************************************************************************************************************************
        //var DebugControlScreenManager = {
        //    info: {
        //        debugContent: 'debug-controls'
        //    },

        //    create: function () {
        //        $('body').append('<div class="debug-controls"></div>');
        //    },

        //    setupControls: function (object, params) {
        //        if (params && params.length > 0) {
        //            $('.' + this.info.debugContent).empty();
        //            var ui = {};
        //            for (var i = 0; i < params.length; ++i) {
        //                if(params[i] && typeof(params[i]) == 'string' && object[params[i]])
        //                {
        //                    $('.' + this.info.debugContent).append('<input type="number" title="' + params[i] + '" value="' + object[params[i]] + '" id="' + params[i] + '"  /><br/>');
        //                    ui["#" + params[i]] = params[i];
        //                }
        //            }
        //            debugger;
        //            //$('.' + this.info.debugContent).my({ ui: ui }, object);
        //        }
        //    }
        //}


    </script>
</body>
</html>
